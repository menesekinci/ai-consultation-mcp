<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Consultation MCP - Configuration</title>

  <!-- Geist Font - Vercel's distinctive typeface -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.14.8/dist/cdn.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist', 'system-ui', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
          colors: {
            // Custom dark theme with amber/orange accent
            surface: {
              DEFAULT: '#0c0c0c',
              50: '#171717',
              100: '#1a1a1a',
              200: '#262626',
              300: '#404040',
            },
            accent: {
              DEFAULT: '#f59e0b',
              50: '#fffbeb',
              100: '#fef3c7',
              200: '#fde68a',
              300: '#fcd34d',
              400: '#fbbf24',
              500: '#f59e0b',
              600: '#d97706',
              700: '#b45309',
              800: '#92400e',
              900: '#78350f',
            },
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out forwards',
            'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
            'slide-in': 'slideIn 0.4s ease-out forwards',
            'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
            'float': 'float 6s ease-in-out infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            slideIn: {
              '0%': { opacity: '0', transform: 'translateX(-10px)' },
              '100%': { opacity: '1', transform: 'translateX(0)' },
            },
            pulseGlow: {
              '0%, 100%': { boxShadow: '0 0 20px rgba(245, 158, 11, 0.1)' },
              '50%': { boxShadow: '0 0 40px rgba(245, 158, 11, 0.2)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0px)' },
              '50%': { transform: 'translateY(-10px)' },
            },
          },
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }

    /* Noise texture overlay */
    .noise-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.03;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    /* Gradient mesh background */
    .gradient-mesh {
      background:
        radial-gradient(ellipse at 20% 0%, rgba(245, 158, 11, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(217, 119, 6, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(180, 83, 9, 0.04) 0%, transparent 70%);
    }

    /* Glassmorphism card */
    .glass-card {
      background: rgba(23, 23, 23, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass-card:hover {
      background: rgba(26, 26, 26, 0.8);
      border-color: rgba(245, 158, 11, 0.2);
      box-shadow: 0 0 30px rgba(245, 158, 11, 0.08);
    }

    /* Staggered animation delays */
    .stagger-1 { animation-delay: 0.1s; }
    .stagger-2 { animation-delay: 0.2s; }
    .stagger-3 { animation-delay: 0.3s; }
    .stagger-4 { animation-delay: 0.4s; }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #0c0c0c;
    }
    ::-webkit-scrollbar-thumb {
      background: #404040;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #525252;
    }

    /* Input focus glow */
    input:focus, select:focus {
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    /* Button hover glow */
    .btn-accent:hover {
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
    }

    /* Line clamp for card preview */
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Card relative positioning for hover effect */
    .glass-card {
      position: relative;
    }
  </style>
</head>
<body class="bg-surface text-neutral-100 min-h-screen font-sans noise-bg gradient-mesh">
  <div x-data="configApp()" x-init="init()" x-cloak class="max-w-5xl mx-auto px-6 py-12">

    <!-- Header -->
    <header class="mb-8 opacity-0 animate-fade-in-up">
      <div class="flex items-center justify-center mb-4">
        <div class="relative">
          <!-- Animated glow ring -->
          <div class="absolute inset-0 bg-accent-500/20 rounded-full blur-xl animate-pulse-glow"></div>
          <div class="relative w-16 h-16 bg-gradient-to-br from-accent-400 to-accent-600 rounded-2xl flex items-center justify-center transform rotate-12 hover:rotate-0 transition-transform duration-500">
            <svg class="w-8 h-8 text-surface" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
        </div>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-center tracking-tight">
        <span class="bg-gradient-to-r from-neutral-100 via-neutral-200 to-neutral-400 bg-clip-text text-transparent">
          Agent Consultation
        </span>
        <span class="text-accent-500"> MCP</span>
      </h1>
      <p class="text-neutral-500 text-center mt-3 text-lg">Enabling agents to get a second opinion</p>
    </header>

    <!-- Tab Navigation -->
    <nav class="mb-8 opacity-0 animate-fade-in-up stagger-1">
      <div class="flex justify-center">
        <div class="inline-flex bg-surface-50/50 p-1 rounded-xl border border-surface-200/50">
          <button
            @click="activeTab = 'config'"
            :class="activeTab === 'config'
              ? 'bg-accent-500 text-surface shadow-lg'
              : 'text-neutral-400 hover:text-neutral-200 hover:bg-surface-200/50'"
            class="flex items-center px-5 py-2.5 rounded-lg font-medium text-sm transition-all duration-300"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Config
          </button>
          <button
            @click="activeTab = 'archive'"
            :class="activeTab === 'archive'
              ? 'bg-accent-500 text-surface shadow-lg'
              : 'text-neutral-400 hover:text-neutral-200 hover:bg-surface-200/50'"
            class="flex items-center px-5 py-2.5 rounded-lg font-medium text-sm transition-all duration-300"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            Archive
            <span
              x-show="historyStats.active + historyStats.archived > 0"
              class="ml-2 px-1.5 py-0.5 text-[10px] rounded-full"
              :class="activeTab === 'archive' ? 'bg-surface/30 text-surface' : 'bg-accent-500/20 text-accent-400'"
              x-text="historyStats.active + historyStats.archived"
            ></span>
          </button>
          <button
            @click="activeTab = 'readme'"
            :class="activeTab === 'readme'
              ? 'bg-accent-500 text-surface shadow-lg'
              : 'text-neutral-400 hover:text-neutral-200 hover:bg-surface-200/50'"
            class="flex items-center px-5 py-2.5 rounded-lg font-medium text-sm transition-all duration-300"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            Readme
          </button>
        </div>
      </div>
    </nav>

    <!-- Toast Notifications (z-[60] to appear above modal z-50) -->
    <div class="fixed top-6 right-6 z-[60] space-y-3">
      <template x-for="toast in toasts" :key="toast.id">
        <div
          x-show="toast.show"
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform translate-x-8 scale-95"
          x-transition:enter-end="opacity-100 transform translate-x-0 scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 scale-100"
          x-transition:leave-end="opacity-0 scale-95"
          :class="{
            'bg-emerald-500/20 border-emerald-500/30 text-emerald-300': toast.type === 'success',
            'bg-red-500/20 border-red-500/30 text-red-300': toast.type === 'error',
            'bg-accent-500/20 border-accent-500/30 text-accent-300': toast.type === 'info'
          }"
          class="px-5 py-3 rounded-xl border backdrop-blur-md shadow-2xl flex items-center space-x-3 font-medium"
        >
          <template x-if="toast.type === 'success'">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </template>
          <template x-if="toast.type === 'error'">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </template>
          <template x-if="toast.type === 'info'">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </template>
          <span x-text="toast.message"></span>
        </div>
      </template>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex flex-col items-center justify-center py-32">
      <div class="relative">
        <div class="absolute inset-0 bg-accent-500/20 rounded-full blur-2xl animate-pulse"></div>
        <div class="relative w-16 h-16 border-4 border-surface-200 border-t-accent-500 rounded-full animate-spin"></div>
      </div>
      <p class="mt-6 text-neutral-500 font-medium">Loading configuration...</p>
    </div>

    <!-- Error State -->
    <div x-show="!loading && loadError" class="flex flex-col items-center justify-center py-32 opacity-0 animate-fade-in-up">
      <div class="relative">
        <div class="absolute inset-0 bg-red-500/10 rounded-full blur-2xl"></div>
        <div class="relative w-20 h-20 bg-red-500/10 rounded-2xl flex items-center justify-center border border-red-500/20">
          <svg class="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
      </div>
      <h3 class="text-2xl font-semibold text-neutral-100 mt-6">Connection Failed</h3>
      <p class="text-neutral-500 mt-2 text-center max-w-md" x-text="loadError"></p>
      <button
        @click="loading = true; loadError = null; init()"
        class="mt-6 px-6 py-3 bg-accent-600 hover:bg-accent-500 rounded-xl font-semibold transition-all duration-300 btn-accent"
      >
        Try Again
      </button>
    </div>

    <!-- Main Content -->
    <div x-show="!loading && !loadError" class="space-y-12">

      <!-- CONFIG TAB -->
      <div x-show="activeTab === 'config'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">

      <!-- Providers Section -->
      <section>
        <div class="flex items-center mb-6">
          <h2 class="text-2xl font-semibold flex items-center">
            <div class="w-10 h-10 bg-accent-500/10 rounded-xl flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
            API Providers
          </h2>
        </div>

        <!-- Provider Cards Grid -->
        <div class="grid gap-4 md:grid-cols-2 mb-8">
          <template x-for="provider in providers" :key="provider.id">
            <div class="glass-card rounded-2xl p-5 transition-all duration-300">
              <!-- Provider Header -->
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  <div
                    class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 border"
                    :class="provider.id === 'deepseek'
                      ? 'bg-gradient-to-br from-blue-500/20 to-purple-500/20 border-blue-500/20'
                      : 'bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border-emerald-500/20'"
                  >
                    <svg class="w-5 h-5" :class="provider.id === 'deepseek' ? 'text-blue-400' : 'text-emerald-400'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-base font-semibold text-neutral-100" x-text="provider.name"></h3>
                    <p class="text-xs text-neutral-500" x-text="provider.description"></p>
                  </div>
                </div>
                <div
                  class="flex items-center px-2 py-1 rounded-lg"
                  :class="provider.hasKey ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-red-500/10 border border-red-500/20'"
                >
                  <div class="w-1.5 h-1.5 rounded-full mr-1.5" :class="provider.hasKey ? 'bg-emerald-400' : 'bg-red-400'"></div>
                  <span class="text-[10px] font-medium" :class="provider.hasKey ? 'text-emerald-400' : 'text-red-400'" x-text="provider.hasKey ? 'Connected' : 'Not Set'"></span>
                </div>
              </div>

              <!-- API Key Status -->
              <template x-if="provider.hasKey">
                <div class="flex items-center text-xs bg-surface-50/50 rounded-lg px-3 py-2 mb-4">
                  <svg class="w-3 h-3 text-emerald-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                  </svg>
                  <code class="text-emerald-400 font-mono text-[11px]" x-text="provider.maskedKey"></code>
                </div>
              </template>

              <!-- Models List -->
              <div class="flex flex-wrap gap-1.5 mb-4">
                <template x-for="model in provider.models" :key="model.id">
                  <span class="text-[10px] px-2 py-1 bg-surface-200/50 text-neutral-400 rounded font-mono" x-text="model.name"></span>
                </template>
              </div>

              <!-- Action Buttons -->
              <div class="flex items-center gap-2">
                <button
                  @click="openKeyModal(provider)"
                  class="flex-1 px-3 py-2 bg-accent-600 hover:bg-accent-500 rounded-lg text-xs font-semibold transition-all duration-300 btn-accent"
                  x-text="provider.hasKey ? 'Update Key' : 'Add API Key'"
                ></button>
                <template x-if="provider.hasKey">
                  <button
                    @click="testKey(provider.id)"
                    :disabled="testing === provider.id"
                    class="px-3 py-2 bg-surface-200 hover:bg-surface-300 rounded-lg text-xs font-medium transition-all duration-300 disabled:opacity-50"
                  >
                    <span x-show="testing !== provider.id">Test</span>
                    <svg x-show="testing === provider.id" class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </button>
                </template>
                <template x-if="provider.hasKey">
                  <button
                    @click="removeKey(provider.id)"
                    class="px-2 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-xs font-medium transition-all duration-300 border border-red-500/20"
                    title="Remove API Key"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- Settings Section -->
        <div class="glass-card rounded-2xl p-6 mt-8">
          <h3 class="text-lg font-semibold text-neutral-100 mb-4">Settings</h3>
          <div class="grid gap-5 md:grid-cols-2">
            <!-- Default Model -->
            <div>
              <label class="block text-xs font-medium text-neutral-500 mb-2 uppercase tracking-wider">Default Model</label>
              <select
                x-model="config.defaultModel"
                @change="saveConfig()"
                class="w-full bg-surface-100 border border-surface-300 rounded-xl px-4 py-3 text-neutral-100 focus:ring-2 focus:ring-accent-500/50 focus:border-accent-500 transition-all duration-300 font-mono text-sm appearance-none cursor-pointer"
                style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%23737373%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%272%27 d=%27M19 9l-7 7-7-7%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1rem;"
              >
                <template x-for="model in config.availableModels" :key="model">
                  <option :value="model" x-text="model"></option>
                </template>
              </select>
            </div>

            <!-- Max Messages -->
            <div>
              <label class="block text-xs font-medium text-neutral-500 mb-2 uppercase tracking-wider">Max Messages</label>
              <input
                type="number"
                x-model="config.maxMessages"
                @change="saveConfig()"
                min="1"
                max="50"
                class="w-full bg-surface-100 border border-surface-300 rounded-xl px-4 py-3 text-neutral-100 focus:ring-2 focus:ring-accent-500/50 focus:border-accent-500 transition-all duration-300 font-mono text-sm"
              />
            </div>
          </div>
        </div>
      </section>

      </div><!-- END CONFIG TAB -->

      <!-- ARCHIVE TAB -->
      <div x-show="activeTab === 'archive'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">

      <!-- Conversation History Section -->
      <section>
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-accent-500/10 rounded-xl flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
            </div>
            <div>
              <h2 class="text-2xl font-semibold">Conversation History</h2>
              <div class="flex items-center gap-3 mt-1">
                <span class="text-xs text-emerald-400" x-text="historyStats.active + ' active'"></span>
                <span class="text-xs text-neutral-500">|</span>
                <span class="text-xs text-neutral-400" x-text="historyStats.archived + ' archived'"></span>
              </div>
            </div>
          </div>
          <button
            @click="loadChatHistory()"
            :disabled="loadingHistory"
            class="px-4 py-2 bg-surface-200 hover:bg-surface-300 rounded-xl text-sm font-medium transition-all duration-300 disabled:opacity-50 flex items-center"
          >
            <svg x-show="!loadingHistory" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <svg x-show="loadingHistory" class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Refresh
          </button>
        </div>

        <!-- Empty State -->
        <template x-if="!loadingHistory && chatHistory.length === 0">
          <div class="glass-card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-surface-200/50 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-neutral-300 mb-2">No Active Conversations</h3>
            <p class="text-neutral-500 text-sm">DeepSeek conversations from Claude Code will appear here.</p>
          </div>
        </template>

        <!-- Conversations Card Grid -->
        <div x-show="chatHistory.length > 0">
          <!-- Card Grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6">
            <template x-for="conv in paginatedHistory" :key="conv.id">
              <div
                @click="openConversationModal(conv)"
                class="glass-card rounded-xl p-4 cursor-pointer transition-all duration-300 hover:scale-[1.02] hover:border-accent-500/40 group"
                :class="conv.status === 'archived' ? 'opacity-80' : ''"
              >
                <!-- Card Header: Status + Model -->
                <div class="flex items-center justify-between mb-3">
                  <span
                    class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wide"
                    :class="conv.status === 'active'
                      ? 'bg-emerald-500/20 text-emerald-400'
                      : 'bg-neutral-500/20 text-neutral-400'"
                    x-text="conv.status === 'active' ? 'Active' : 'Archived'"
                  ></span>
                  <template x-if="conv.status === 'archived' && conv.endReason">
                    <span
                      class="px-2 py-0.5 rounded text-[10px] font-medium"
                      :class="conv.endReason === 'completed'
                        ? 'bg-blue-500/20 text-blue-400'
                        : 'bg-orange-500/20 text-orange-400'"
                      x-text="conv.endReason === 'completed' ? 'Done' : 'Timeout'"
                    ></span>
                  </template>
                </div>

                <!-- Model Badge -->
                <div class="mb-3">
                  <span class="px-2 py-1 bg-accent-500/15 text-accent-400 rounded text-xs font-mono" x-text="conv.model"></span>
                </div>

                <!-- Message Preview -->
                <div class="mb-3 min-h-[60px]">
                  <p class="text-xs text-neutral-400 line-clamp-3" x-text="conv.messages[0]?.content.substring(0, 100) + (conv.messages[0]?.content.length > 100 ? '...' : '') || 'No messages'"></p>
                </div>

                <!-- Card Footer: Stats -->
                <div class="flex items-center justify-between pt-3 border-t border-surface-300/20">
                  <div class="flex items-center text-neutral-500">
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span class="text-[11px]" x-text="conv.messageCount"></span>
                  </div>
                  <span class="text-[10px] text-neutral-600" x-text="new Date(conv.createdAt).toLocaleDateString()"></span>
                </div>

                <!-- Hover indicator -->
                <div class="absolute inset-0 rounded-xl border-2 border-transparent group-hover:border-accent-500/20 transition-all duration-300 pointer-events-none"></div>
              </div>
            </template>
          </div>

          <!-- Pagination Controls -->
          <div class="flex items-center justify-between glass-card rounded-xl px-4 py-3">
            <div class="text-sm text-neutral-500">
              <span x-text="'Showing ' + ((currentPage - 1) * itemsPerPage + 1) + '-' + Math.min(currentPage * itemsPerPage, chatHistory.length) + ' of ' + chatHistory.length"></span>
            </div>
            <div class="flex items-center gap-2">
              <!-- Previous Button -->
              <button
                @click="prevPage()"
                :disabled="currentPage === 1"
                class="px-3 py-1.5 bg-surface-200 hover:bg-surface-300 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>

              <!-- Page Numbers -->
              <div class="flex items-center gap-1">
                <template x-for="page in totalPages" :key="page">
                  <button
                    x-show="page === 1 || page === totalPages || (page >= currentPage - 1 && page <= currentPage + 1)"
                    @click="goToPage(page)"
                    class="w-8 h-8 rounded-lg text-sm font-medium transition-all duration-200"
                    :class="page === currentPage
                      ? 'bg-accent-500 text-surface'
                      : 'bg-surface-200 hover:bg-surface-300 text-neutral-300'"
                    x-text="page"
                  ></button>
                </template>
              </div>

              <!-- Next Button -->
              <button
                @click="nextPage()"
                :disabled="currentPage === totalPages"
                class="px-3 py-1.5 bg-surface-200 hover:bg-surface-300 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      </div><!-- END ARCHIVE TAB -->

      <!-- README TAB -->
      <div x-show="activeTab === 'readme'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
        <section>
          <!-- Hero Section -->
          <div class="glass-card rounded-2xl p-8 mb-8 text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-accent-400 to-accent-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
              <svg class="w-10 h-10 text-surface" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
            </div>
            <h2 class="text-3xl font-bold text-neutral-100 mb-4">Agent Consultation MCP</h2>
            <p class="text-lg text-neutral-400 max-w-2xl mx-auto leading-relaxed">
              Enabling AI agents to get a <span class="text-accent-400 font-semibold">second opinion</span> to enrich their perspectives during work.
            </p>
          </div>

          <!-- Purpose Section -->
          <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 bg-blue-500/10 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
              </div>
              <div>
                <h3 class="text-xl font-semibold text-neutral-100 mb-2">Purpose</h3>
                <p class="text-neutral-400 leading-relaxed">
                  When AI agents work on complex tasks, having a single perspective can lead to blind spots or suboptimal solutions.
                  This MCP server enables agents like Claude Code to consult with other AI models (DeepSeek, ChatGPT)
                  to get alternative viewpoints, validate approaches, or explore different problem-solving strategies.
                </p>
              </div>
            </div>
          </div>

          <!-- How It Works Section -->
          <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 bg-emerald-500/10 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
              </div>
              <div>
                <h3 class="text-xl font-semibold text-neutral-100 mb-2">How It Works</h3>
                <div class="space-y-3 text-neutral-400">
                  <div class="flex items-start gap-3">
                    <span class="w-6 h-6 bg-accent-500/20 text-accent-400 rounded-full flex items-center justify-center text-sm font-semibold shrink-0">1</span>
                    <p>An AI agent (like Claude Code) encounters a complex problem or wants to validate an approach.</p>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="w-6 h-6 bg-accent-500/20 text-accent-400 rounded-full flex items-center justify-center text-sm font-semibold shrink-0">2</span>
                    <p>Using <code class="bg-surface-200 px-1.5 py-0.5 rounded text-xs font-mono text-accent-300">consult_agent</code> tool, it starts a consultation with another model.</p>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="w-6 h-6 bg-accent-500/20 text-accent-400 rounded-full flex items-center justify-center text-sm font-semibold shrink-0">3</span>
                    <p>The consulted model provides its perspective, suggestions, or alternative solutions.</p>
                  </div>
                  <div class="flex items-start gap-3">
                    <span class="w-6 h-6 bg-accent-500/20 text-accent-400 rounded-full flex items-center justify-center text-sm font-semibold shrink-0">4</span>
                    <p>The original agent integrates this second opinion into its work, leading to richer outcomes.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Benefits Section -->
          <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 bg-purple-500/10 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
              </div>
              <div>
                <h3 class="text-xl font-semibold text-neutral-100 mb-4">Benefits</h3>
                <div class="grid gap-4 md:grid-cols-2">
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <h4 class="font-semibold text-neutral-200 mb-1">Reduced Blind Spots</h4>
                    <p class="text-sm text-neutral-500">Different models have different training data and reasoning patterns.</p>
                  </div>
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <h4 class="font-semibold text-neutral-200 mb-1">Better Problem Solving</h4>
                    <p class="text-sm text-neutral-500">Multiple perspectives often lead to more creative solutions.</p>
                  </div>
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <h4 class="font-semibold text-neutral-200 mb-1">Validation</h4>
                    <p class="text-sm text-neutral-500">Get confirmation or alternative suggestions for critical decisions.</p>
                  </div>
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <h4 class="font-semibold text-neutral-200 mb-1">Specialized Expertise</h4>
                    <p class="text-sm text-neutral-500">DeepSeek Reasoner excels at step-by-step reasoning tasks.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- MCP Tools Section -->
          <div class="glass-card rounded-2xl p-6">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 bg-accent-500/10 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-6 h-6 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
              </div>
              <div class="flex-1">
                <h3 class="text-xl font-semibold text-neutral-100 mb-4">Available MCP Tools</h3>
                <div class="space-y-4">
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <div class="flex items-center gap-2 mb-2">
                      <code class="bg-accent-500/20 text-accent-300 px-2 py-1 rounded text-sm font-mono">consult_agent</code>
                      <span class="text-xs text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded">Primary</span>
                    </div>
                    <p class="text-sm text-neutral-400">Start a new consultation or continue an existing one. Supports multi-turn conversations.</p>
                  </div>
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <div class="flex items-center gap-2 mb-2">
                      <code class="bg-surface-200 text-neutral-300 px-2 py-1 rounded text-sm font-mono">continue_conversation</code>
                    </div>
                    <p class="text-sm text-neutral-400">Continue an existing consultation with follow-up messages.</p>
                  </div>
                  <div class="bg-surface-50/50 rounded-xl p-4 border border-surface-200/30">
                    <div class="flex items-center gap-2 mb-2">
                      <code class="bg-surface-200 text-neutral-300 px-2 py-1 rounded text-sm font-mono">end_conversation</code>
                    </div>
                    <p class="text-sm text-neutral-400">End a consultation and archive the conversation for reference.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div><!-- END README TAB -->

      <!-- Footer -->
      <footer class="text-center pt-12 border-t border-surface-200/30 opacity-0 animate-fade-in stagger-4">
        <div class="flex items-center justify-center space-x-2 text-neutral-600">
          <span class="font-mono text-sm">Agent Consultation MCP</span>
          <span class="text-accent-500">â€¢</span>
          <span class="font-mono text-sm">v1.5.1</span>
        </div>
        <p class="text-neutral-600 text-sm mt-2">Configuration changes are saved automatically</p>
      </footer>
    </div>

    <!-- API Key Modal -->
    <div
      x-cloak
      x-show="showModal"
      style="display: none;"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
      @click.self="closeModal()"
    >
      <div
        x-show="showModal"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-90 translate-y-4"
        x-transition:enter-end="opacity-100 scale-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-90"
        class="glass-card rounded-2xl max-w-md w-full p-8 border border-surface-300/50"
      >
        <div class="flex items-center mb-6">
          <div class="w-12 h-12 bg-accent-500/10 rounded-xl flex items-center justify-center mr-4">
            <svg class="w-6 h-6 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-neutral-100" x-text="'Configure ' + (modalProvider?.name || '')"></h3>
            <p class="text-sm text-neutral-500">Enter your API key below</p>
          </div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-neutral-300 mb-2">API Key</label>
            <input
              type="password"
              x-model="modalApiKey"
              @keyup.enter="saveKey()"
              placeholder="sk-..."
              class="w-full bg-surface-100 border border-surface-300 rounded-xl px-4 py-3 text-neutral-100 placeholder-neutral-600 focus:ring-2 focus:ring-accent-500/50 focus:border-accent-500 transition-all duration-300 font-mono text-sm"
            />
            <p class="text-xs text-neutral-600 mt-2 flex items-center">
              <svg class="w-3 h-3 mr-1 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              Encrypted with AES-256-GCM before storage
            </p>
          </div>

          <div class="flex gap-3 pt-2">
            <button
              @click="saveKey()"
              :disabled="!modalApiKey || saving"
              class="flex-1 px-5 py-3 bg-accent-600 hover:bg-accent-500 rounded-xl font-semibold transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed btn-accent"
            >
              <span x-show="!saving">Save Key</span>
              <span x-show="saving" class="flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
              </span>
            </button>
            <button
              @click="testKeyModal()"
              :disabled="!modalApiKey || testingModal"
              class="px-5 py-3 bg-surface-200 hover:bg-surface-300 rounded-xl font-medium transition-all duration-300 disabled:opacity-50"
            >
              <span x-show="!testingModal">Test</span>
              <span x-show="testingModal">
                <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            </button>
            <button
              @click="closeModal()"
              class="px-5 py-3 bg-surface-200 hover:bg-surface-300 rounded-xl font-medium transition-all duration-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Conversation Detail Modal -->
    <div
      x-cloak
      x-show="showConversationModal"
      style="display: none;"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4"
      @click.self="closeConversationModal()"
      @keydown.escape.window="closeConversationModal()"
    >
      <div
        x-show="showConversationModal"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-90 translate-y-4"
        x-transition:enter-end="opacity-100 scale-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-90"
        class="glass-card rounded-2xl w-full max-w-3xl max-h-[85vh] flex flex-col border border-surface-300/50"
      >
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-5 border-b border-surface-300/30 shrink-0">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-accent-500/10 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-neutral-100">Conversation Details</h3>
              <div class="flex items-center gap-2 mt-1">
                <template x-if="selectedConversation">
                  <span
                    class="px-2 py-0.5 rounded text-[10px] font-semibold uppercase"
                    :class="selectedConversation.status === 'active'
                      ? 'bg-emerald-500/20 text-emerald-400'
                      : 'bg-neutral-500/20 text-neutral-400'"
                    x-text="selectedConversation.status"
                  ></span>
                </template>
                <template x-if="selectedConversation">
                  <span class="px-2 py-0.5 bg-accent-500/15 text-accent-400 rounded text-xs font-mono" x-text="selectedConversation.model"></span>
                </template>
                <template x-if="selectedConversation">
                  <span class="text-xs text-neutral-500" x-text="selectedConversation.messageCount + ' messages'"></span>
                </template>
              </div>
            </div>
          </div>
          <button
            @click="closeConversationModal()"
            class="w-10 h-10 bg-surface-200 hover:bg-surface-300 rounded-xl flex items-center justify-center transition-all duration-200"
          >
            <svg class="w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Modal Body - Scrollable Messages -->
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
          <template x-if="selectedConversation">
            <template x-for="msg in selectedConversation.messages" :key="msg.id">
              <div class="flex" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                <div
                  class="max-w-[85%] rounded-xl px-4 py-3"
                  :class="msg.role === 'user'
                    ? 'bg-accent-600/20 text-neutral-100 border border-accent-500/30'
                    : 'bg-surface-200/50 text-neutral-200 border border-surface-300/30'"
                >
                  <div class="flex items-center mb-2">
                    <div
                      class="w-6 h-6 rounded-lg flex items-center justify-center mr-2"
                      :class="msg.role === 'user' ? 'bg-accent-500/30' : 'bg-emerald-500/30'"
                    >
                      <template x-if="msg.role === 'user'">
                        <svg class="w-3.5 h-3.5 text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                      </template>
                      <template x-if="msg.role !== 'user'">
                        <svg class="w-3.5 h-3.5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                      </template>
                    </div>
                    <span class="text-xs font-semibold" :class="msg.role === 'user' ? 'text-accent-400' : 'text-emerald-400'" x-text="msg.role === 'user' ? 'Claude Code' : 'DeepSeek'"></span>
                  </div>
                  <div class="text-sm whitespace-pre-wrap break-words leading-relaxed" x-text="msg.content"></div>
                </div>
              </div>
            </template>
          </template>
        </div>

        <!-- Modal Footer -->
        <div class="p-4 border-t border-surface-300/30 shrink-0">
          <template x-if="selectedConversation">
            <div class="flex items-center justify-between text-xs text-neutral-500">
              <code class="font-mono bg-surface-200/50 px-2 py-1 rounded" x-text="'ID: ' + selectedConversation.id"></code>
              <div class="flex items-center gap-3">
                <span x-text="'Created: ' + new Date(selectedConversation.createdAt).toLocaleString()"></span>
                <template x-if="selectedConversation.status === 'archived' && selectedConversation.endedAt">
                  <span x-text="'Ended: ' + new Date(selectedConversation.endedAt).toLocaleString()"></span>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <script>
    function configApp() {
      return {
        loading: true,
        loadError: null,
        providers: [],
        config: {
          defaultModel: '',
          maxMessages: 5,
          availableModels: [],
        },
        toasts: [],
        showModal: false,
        modalProvider: null,
        modalApiKey: '',
        saving: false,
        testing: null,
        testingModal: false,
        chatHistory: [],
        loadingHistory: false,
        historyStats: { active: 0, archived: 0 },
        // Tab navigation
        activeTab: 'config',
        // Pagination state
        currentPage: 1,
        itemsPerPage: 10,
        // Conversation detail modal
        selectedConversation: null,
        showConversationModal: false,

        // Computed: total pages
        get totalPages() {
          return Math.ceil(this.chatHistory.length / this.itemsPerPage) || 1;
        },

        // Computed: paginated history
        get paginatedHistory() {
          const start = (this.currentPage - 1) * this.itemsPerPage;
          const end = start + this.itemsPerPage;
          return this.chatHistory.slice(start, end);
        },

        // Pagination methods
        goToPage(page) {
          if (page >= 1 && page <= this.totalPages) {
            this.currentPage = page;
          }
        },
        nextPage() {
          if (this.currentPage < this.totalPages) {
            this.currentPage++;
          }
        },
        prevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
          }
        },

        // Conversation modal methods
        openConversationModal(conv) {
          this.selectedConversation = conv;
          this.showConversationModal = true;
          document.body.style.overflow = 'hidden';
        },
        closeConversationModal() {
          this.showConversationModal = false;
          this.selectedConversation = null;
          document.body.style.overflow = '';
        },

        async init() {
          try {
            await this.loadData();
            // Also load chat history on init
            this.loadChatHistory();
          } catch (error) {
            console.error('Init failed:', error);
            this.loadError = error.message || 'Failed to initialize';
          } finally {
            this.loading = false;
          }
        },

        async loadData() {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);

          try {
            const [providersRes, configRes] = await Promise.all([
              fetch('/api/providers', { signal: controller.signal }),
              fetch('/api/config', { signal: controller.signal }),
            ]);

            if (!providersRes.ok) {
              const errorText = await providersRes.text();
              throw new Error(`Providers API failed (${providersRes.status}): ${errorText}`);
            }
            if (!configRes.ok) {
              const errorText = await configRes.text();
              throw new Error(`Config API failed (${configRes.status}): ${errorText}`);
            }

            this.providers = await providersRes.json();
            this.config = await configRes.json();
            this.loadError = null;
          } catch (error) {
            console.error('loadData error:', error);
            if (error.name === 'AbortError') {
              this.showToast('Request timed out. Is the server running?', 'error');
              throw new Error('Request timed out');
            }
            this.showToast('Failed to load: ' + error.message, 'error');
            throw error;
          } finally {
            clearTimeout(timeoutId);
          }
        },

        async saveConfig() {
          try {
            const res = await fetch('/api/config', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                defaultModel: this.config.defaultModel,
                maxMessages: parseInt(this.config.maxMessages, 10),
              }),
            });

            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.message || 'Failed to save');
            }

            this.showToast('Settings saved', 'success');
          } catch (error) {
            this.showToast('Failed to save settings: ' + error.message, 'error');
          }
        },

        openKeyModal(provider) {
          this.modalProvider = provider;
          this.modalApiKey = '';
          this.showModal = true;
        },

        closeModal() {
          this.showModal = false;
          this.modalProvider = null;
          this.modalApiKey = '';
        },

        async saveKey() {
          if (!this.modalApiKey || !this.modalProvider) return;

          this.saving = true;
          try {
            const res = await fetch(`/api/providers/${this.modalProvider.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ apiKey: this.modalApiKey }),
            });

            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.message || 'Failed to save');
            }

            this.showToast(`${this.modalProvider.name} API key saved`, 'success');
            this.closeModal();
            await this.loadData();
          } catch (error) {
            this.showToast('Failed to save API key: ' + error.message, 'error');
          } finally {
            this.saving = false;
          }
        },

        async testKey(providerId) {
          this.testing = providerId;
          try {
            const res = await fetch(`/api/providers/${providerId}/test`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({}),
            });

            const data = await res.json();
            if (data.valid) {
              this.showToast(data.message, 'success');
            } else {
              this.showToast(data.message, 'error');
            }
          } catch (error) {
            this.showToast('Test failed: ' + error.message, 'error');
          } finally {
            this.testing = null;
          }
        },

        async testKeyModal() {
          if (!this.modalApiKey || !this.modalProvider) return;

          this.testingModal = true;
          try {
            const res = await fetch(`/api/providers/${this.modalProvider.id}/test`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ apiKey: this.modalApiKey }),
            });

            const data = await res.json();
            if (data.valid) {
              this.showToast(data.message, 'success');
            } else {
              this.showToast(data.message, 'error');
            }
          } catch (error) {
            this.showToast('Test failed: ' + error.message, 'error');
          } finally {
            this.testingModal = false;
          }
        },

        async removeKey(providerId) {
          if (!confirm('Are you sure you want to remove this API key?')) return;

          try {
            const res = await fetch(`/api/providers/${providerId}`, {
              method: 'DELETE',
            });

            if (!res.ok) {
              const data = await res.json();
              throw new Error(data.message || 'Failed to remove');
            }

            this.showToast('API key removed', 'success');
            await this.loadData();
          } catch (error) {
            this.showToast('Failed to remove API key: ' + error.message, 'error');
          }
        },

        showToast(message, type = 'info') {
          const id = Date.now();
          const toast = { id, message, type, show: true };
          this.toasts.push(toast);

          setTimeout(() => {
            toast.show = false;
            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== id);
            }, 200);
          }, 3000);
        },

        async loadChatHistory() {
          this.loadingHistory = true;
          this.currentPage = 1;  // Reset to first page on refresh
          try {
            const res = await fetch('/api/chat/history');
            if (!res.ok) {
              throw new Error('Failed to fetch history');
            }
            const data = await res.json();
            this.chatHistory = data.conversations || [];
            this.historyStats = {
              active: data.activeCount || 0,
              archived: data.archivedCount || 0,
            };
          } catch (error) {
            console.error('Failed to load chat history:', error);
            // Silent fail - don't show error toast for history
          } finally {
            this.loadingHistory = false;
          }
        },
      };
    }
  </script>
</body>
</html>
